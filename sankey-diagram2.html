<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>history sankey diagram</title>
        <script src="https://d3js.org/d3.v4.js"></script>
    </head>
    <style>
        .node rect {
            cursor: move;
            fill-opacity: .5;
        }

        .link {
            fill: #00FFFF;
            stroke: #000;
            stroke-opacity: .2;
            fill-opacity: .1;
        }
    </style>
    <body>
        <div id="sankey-chart"></div>
        <script>
            var width = 800, height = 400;
            var margin = 5;

            var svg = d3.select('#sankey-chart')
                        .append('svg')
                            .attr('width', width)
                            .attr('height', height);

            var area = d3.area()
                        .x0(function(d){ return d.x0;})
                        .x1(function(d){ return d.x1;})
                        .y0(function(d){ return d.y0;})
                        .y1(function(d){ return d.y1;});

            d3.json('unit3.json', function(data){
                
                var nodes = [], links = [];

                sankey(data, nodes, links, width, height, margin);

                console.log(nodes);
                console.log(links);


                var node = svg.append('g').selectAll('.node')
                            .data(nodes)
                            .enter()
                                .append('g')
                                    .attr('class', 'node')
                                    .attr('transform', function(d){
                                        return 'translate(' + d.x + ',' + d.y + ')';
                                    });

                node.append('rect')
                    .attr('width', 20)
                    .attr('height', function(d){
                        return d.height;
                    })
                    .style('fill', 'steelblue')
                    .style('stroke', 'black');

                var link = svg.append('g').selectAll('.link')
                            .data(links)
                            .enter()
                                .append('path')
                                    .attr('class', 'link')
                                    .attr('d', function(d){

                                        console.log(d);

                                        var area_data = [
                                            {'x0': d.source.x0, 'y0': d.source.y0, 
                                             'x1': d.source.x1, 'y1': d.source.y1},
                                            {'x0': d.target.x0, 'y0': d.target.y0, 
                                             'x1': d.target.x1, 'y1': d.target.y1},
                                        ];

                                        return area(area_data);
                                    });


            });

            function sankey(data, nodes, links, width, height, margin){

                // nodes
                sankey_nodeXDS(data, nodes, 0, null, width, height);
                sankey_nodeYH(nodes, height, margin);

                // links   
                sankey_link(nodes, links, width, height);

            }

            function sankey_nodeXDS(data, nodes, depth, parent, width, height){
                var x = depth * 200;
                var source;

                if(parent == null)
                    source = -1;
                else
                    source = parent;
                
                nodes.push({
                    'name': data.name,
                    'log_num': data.log_num,
                    'action_num': data.action_num,
                    'last_date': data.last_date,
                    'ver': data.ver,
                    'anno_num': data.anno_num,
                    'x': x,
                    'depth': depth,
                    'source': source
                });

                if(data.children){
                    var tmp = nodes.length-1;
                    for(var i = 0; i < data.children.length; i++){
                        sankey_nodeXDS(data.children[i], nodes, depth+1, tmp, width, height);
                    }
                }
            }

            function sankey_nodeYH(nodes, height, margin){
                var depth_sum = [];
                var y_tmp = [];

                for(var i = 0; i < nodes.length; i++){
                    if(depth_sum[nodes[i].depth] == undefined)
                        depth_sum[nodes[i].depth] = nodes[i].action_num;
                    else 
                        depth_sum[nodes[i].depth] += nodes[i].action_num;
                }

                for(var i = 0; i < nodes.length; i++){
                    var node_height = height * nodes[i].action_num / depth_sum[nodes[i].depth];

                    if(y_tmp[nodes[i].depth] == undefined){
                        nodes[i]['y'] = 0;
                        y_tmp[nodes[i].depth] = node_height;  
                    }
                    else {
                        nodes[i]['y'] = y_tmp[nodes[i].depth]    
                        y_tmp[nodes[i].depth] += node_height;
                    }

                    nodes[i]['height'] = node_height - margin;
                }
            }

            function sankey_link(nodes, links, width, height){

                var source_sum = [];

                for(var i = 0; i < nodes.length; i++){
                    var source = nodes[i].source;
                    var target = i;

                    if(source != -1){

                        if(source_sum[source] == undefined)
                            source_sum[source] = 0;

                        links.push({
                            'source':{
                                'x0': nodes[source].x+20, 
                                'y0': nodes[source].y + 
                                      source_sum[source],
                                'x1': nodes[source].x+20, 
                                'y1': nodes[source].y + 
                                      source_sum[source] +
                                      nodes[source].height * 
                                      nodes[target].action_num / 
                                      nodes[source].action_num
                            },
                            'target':{
                                'x0': nodes[target].x, 'y0': nodes[target].y,
                                'x1': nodes[target].x, 'y1': nodes[target].y + nodes[target].height
                            }
                        })

                        source_sum[source] += 
                                      nodes[source].height * 
                                      nodes[target].action_num / 
                                      nodes[source].action_num

                    }
                }
            }

        </script>
    </body>
</html>